<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafedium Διαχειριστής</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
    // Έλεγχος για σφάλματα φόρτωσης
    window.addEventListener('error', function(e) {
        console.error('Global error:', e.error);
    });

    // Έλεγχος αν τα Firebase objects είναι διαθέσιμα
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded');
        console.log('Firebase available:', typeof firebase !== 'undefined');
        console.log('Auth available:', typeof auth !== 'undefined');
        console.log('DB available:', typeof db !== 'undefined');
    });
</script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config για το Panel Διαχειριστή -->
    <script src="panel-firebase-config.js"></script>
    
    <style>
        /* ΟΛΑ ΤΑ STYLES ΜΕΝΟΥΝ ΙΔΙΑ */
        :root {
            --primary: #8B4513;
            --primary-light: #A0522D;
            --secondary: #D2691E;
            --accent: #F4A460;
            --light: #F5F5DC;
            --dark: #3E2723;
            --text: #5D4037;
            --success: #4CAF50;
            --error: #f44336;
            --info: #2196F3;
            --warning: #FF9800;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--light) 0%, #f8f4e9 100%);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* ΟΛΑ ΤΑ ΑΛΛΑ STYLES ΜΕΝΟΥΝ ΙΔΙΑ */
        /* ... */
        
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal" id="login-modal">
        <div class="login-modal-content">
            <div class="login-header">
                <i class="fas fa-mug-hot login-logo"></i>
                <h2 class="login-title">Σύνδεση Διαχειριστή</h2>
            </div>
            <div class="login-body">
                <div class="form-group">
                    <label for="admin-email"><i class="fas fa-envelope"></i> Email Διαχειριστή:</label>
                    <input type="email" id="admin-email" class="form-control" placeholder="admin@cafedium.gr" required>
                </div>
                
                <div class="form-group">
                    <label for="admin-password"><i class="fas fa-lock"></i> Κωδικός Πρόσβασης:</label>
                    <input type="password" id="admin-password" class="form-control" placeholder="Εισάγετε τον κωδικό σας" required>
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="remember-me">
                    <label for="remember-me">Να με θυμάσαι</label>
                </div>
                
                <button class="login-btn" id="admin-login-btn">
                    <i class="fas fa-sign-in-alt"></i> Σύνδεση
                </button>
                
                <div class="setup-info" id="first-time-setup" style="display: none;">
                    <h4><i class="fas fa-info-circle"></i> Πρώτη Σύνδεση</h4>
                    <p>Εφόσον είναι η πρώτη σας σύνδεση, θα δημιουργηθεί νέος λογαριασμός διαχειριστή με τα διαπιστευτήρια που εισάγατε. Αυτά τα διαπιστευτήρια θα είναι διαθέσιμα από οποιοδήποτε browser.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Content -->
    <div class="main-content" id="main-content">
        <div class="container">
            <header>
                <i class="fas fa-mug-hot logo"></i>
                <h1>Πίνακας Διαχειριστή</h1>
                <p class="subtitle">Διαχείριση υποβολών και μηνυμάτων από επισκέπτες</p>
            </header>
            
            <div class="admin-info">
                <div class="admin-welcome">
                    <i class="fas fa-user-shield"></i> Καλώς ήρθες, <span id="admin-name">Διαχειριστή</span>!
                </div>
                <div class="admin-actions">
                    <button class="main-app-btn" id="mainAppBtn">
                        <i class="fas fa-home"></i> Κύρια Εφαρμογή
                    </button>
                    <button class="sync-btn" id="syncUsersBtn">
                        <i class="fas fa-sync"></i> Συγχρονισμός
                    </button>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Αποσύνδεση
                    </button>
                </div>
            </div>
            
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-images"></i>
                    </div>
                    <div class="stat-number" id="total-submissions">0</div>
                    <div class="stat-label">Συνολικές Υποβολές</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-number" id="pending-submissions">0</div>
                    <div class="stat-label">Υποβολές σε Εκκρεμότητα</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-number" id="answered-submissions">0</div>
                    <div class="stat-label">Απαντημένες Υποβολές</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-number" id="registered-users">0</div>
                    <div class="stat-label">Εγγεγραμμένοι Χρήστες</div>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="photos-tab">
                    <i class="fas fa-camera"></i> Υποβολές
                </button>
                <button class="tab" data-tab="messages-tab">
                    <i class="fas fa-envelope"></i> Μηνύματα
                </button>
                <button class="tab" data-tab="users-tab">
                    <i class="fas fa-users"></i> Χρήστες
                </button>
                <button class="tab" data-tab="offers-tab">
                    <i class="fas fa-gift"></i> Προσφορές
                </button>
                <button class="tab" data-tab="notifications-tab" id="notificationsTab">
                    <i class="fas fa-bell"></i> Ειδοποιήσεις
                    <span class="notifications-badge" id="notificationsBadge" style="display: none;">0</span>
                </button>
            </div>
            
            <main>
                <!-- Καρτέλα Υποβολών Φωτογραφιών -->
                <section id="photos-tab" class="tab-content active">
                    <div class="content-section">
                        <h2><i class="fas fa-images"></i> Υποβολές Φωτογραφιών Καφέ</h2>
                        
                        <div class="filters">
                            <select class="filter-select" id="status-filter">
                                <option value="all">Όλες οι Καταστάσεις</option>
                                <option value="pending">Σε Εκκρεμότητα</option>
                                <option value="reviewed">Εξετασμένες</option>
                                <option value="answered">Απαντημένες</option>
                            </select>
                            
                            <select class="filter-select" id="date-filter">
                                <option value="all">Όλες οι Ημερομηνίες</option>
                                <option value="today">Σήμερα</option>
                                <option value="week">Τελευταία 7 Ημέρες</option>
                                <option value="month">Τελευταίος Μήνας</option>
                            </select>
                            
                            <input type="text" class="search-input" id="search-input" placeholder="Αναζήτηση με email...">
                        </div>
                        
                        <div class="submissions-list" id="photo-submissions-list">
                            <!-- Θα προστεθούν δυναμικά οι υποβολές -->
                        </div>
                    </div>
                </section>
                
                <!-- Καρτέλα Μηνυμάτων Επικοινωνίας -->
                <section id="messages-tab" class="tab-content">
                    <div class="content-section">
                        <h2><i class="fas fa-comments"></i> Μηνύματα Επικοινωνίας</h2>
                        
                        <div class="filters">
                            <select class="filter-select" id="message-status-filter">
                                <option value="all">Όλα τα Μηνύματα</option>
                                <option value="pending">Σε Εκκρεμότητα</option>
                                <option value="answered">Απαντημένα</option>
                            </select>
                            
                            <input type="text" class="search-input" id="message-search-input" placeholder="Αναζήτηση με όνομα ή email...">
                        </div>
                        
                        <div class="submissions-list" id="message-submissions-list">
                            <!-- Θα προστεθούν δυναμικά τα μηνύματα -->
                        </div>
                    </div>
                </section>
                
                <!-- Καρτέλα Διαχείρισης Χρηστών -->
                <section id="users-tab" class="tab-content">
                    <div class="content-section">
                        <h2><i class="fas fa-users"></i> Διαχείριση Εγγεγραμμένων Χρηστών</h2>
                        
                        <div class="filters">
                            <input type="text" class="search-input" id="user-search-input" placeholder="Αναζήτηση με όνομα ή email...">
                        </div>
                        
                        <div class="users-list" id="users-list">
                            <!-- Θα προστεθεί δυναμικά ο πίνακας χρηστών -->
                        </div>
                    </div>
                </section>

                <!-- Καρτέλα Διαχείρισης Προσφορών -->
                <section id="offers-tab" class="tab-content">
                    <div class="content-section">
                        <h2><i class="fas fa-gift"></i> Διαχείριση Προσφορών</h2>
                        
                        <div class="offer-management">
                            <div class="offer-item">
                                <h3>Προσφορά 1+1 Δώρο</h3>
                                <p>Ενεργοποίηση της προσφοράς 1+1 δώρο για όλους τους χρήστες.</p>
                                
                                <div class="offer-controls">
                                    <div class="form-group">
                                        <label for="offer-1plus1-status">Κατάσταση:</label>
                                        <select class="filter-select" id="offer-1plus1-status">
                                            <option value="active">Ενεργή</option>
                                            <option value="inactive">Ανενεργή</option>
                                        </select>
                                    </div>
                                        
                                    <div class="form-group">
                                        <label for="offer-1plus1-duration">Διάρκεια (ώρες):</label>
                                        <input type="number" id="offer-1plus1-duration" class="filter-select" min="1" max="168" value="24">
                                    </div>
                                        
                                    <button class="action-btn btn-reply" id="save-offer-1plus1">
                                        <i class="fas fa-save"></i> Αποθήκευση Ρυθμίσεων
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Καρτέλα Ειδοποιήσεων -->
                <section id="notifications-tab" class="tab-content">
                    <div class="content-section">
                        <h2><i class="fas fa-bell"></i> Ειδοποιήσεις Ανταλλαγών</h2>
                        
                        <div class="submissions-list" id="notifications-list">
                            <!-- Θα προστεθούν δυναμικά οι ειδοποιήσεις -->
                        </div>
                    </div>
                </section>
            </main>
            
            <footer>
                <p>
                    Cafedium <span class="coffee-icon">☕</span> 
                    Πίνακας Διαχειριστή
                </p>
                <p>© 2023 - Όλα τα δικαιώματα διατηρούνται</p>
            </footer>
        </div>

        <!-- Modal για προβολή υποβολής -->
        <div class="modal" id="submission-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Προβολή Υποβολής</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Θα προστεθεί δυναμικά το περιεχόμενο -->
                </div>
            </div>
        </div>

        <!-- Modal για απάντηση -->
        <div class="modal" id="reply-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Απάντηση στον Χρήστη</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="reply-user-info">
                        <!-- Θα προστεθούν δυναμικά τα στοιχεία του χρήστη -->
                    </div>
                    
                    <div class="reply-form">
                        <div class="form-group">
                            <label for="reply-message">Μήνυμα Απάντησης:</label>
                            <textarea id="reply-message" placeholder="Γράψτε το μήνυμα απάντησής σας εδώ...&#10;&#10;Μπορείτε να επικολλήσετε URLs που θα μετατραπούν αυτόματα σε clickable links για τον χρήστη."></textarea>
                        </div>
                        
                        <div class="url-preview" id="url-preview" style="display: none;">
                            <h4>Προεπισκόπηση URLs:</h4>
                            <div id="url-preview-content"></div>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="action-btn btn-view" id="cancel-reply">
                                <i class="fas fa-times"></i> Ακύρωση
                            </button>
                            <button class="action-btn btn-reply" id="send-reply">
                                <i class="fas fa-paper-plane"></i> Αποστολή Απάντησης
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal για διαχείριση πόντων -->
        <div class="modal" id="points-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Διαχείριση Πόντων Χρήστη</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="points-user-info">
                        <!-- Θα προστεθούν δυναμικά τα στοιχεία του χρήστη -->
                    </div>
                    
                    <div class="points-management">
                        <div class="form-group">
                            <label for="current-points">Τρέχοντες Πόντοι:</label>
                            <input type="number" id="current-points" class="filter-select" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="points-action">Ενέργεια:</label>
                            <select class="filter-select" id="points-action">
                                <option value="add">Προσθήκη Πόντων</option>
                                <option value="remove">Αφαίρεση Πόντων</option>
                                <option value="set">Ορισμός Πόντων</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="points-amount">Ποσότητα Πόντων:</label>
                            <input type="number" id="points-amount" class="filter-select" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="points-reason">Αιτιολογία (προαιρετικά):</label>
                            <textarea id="points-reason" placeholder="Προσθέστε μια σύντομη αιτιολογία για την αλλαγή των πόντων..."></textarea>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="action-btn btn-view" id="cancel-points">
                                <i class="fas fa-times"></i> Ακύρωση
                            </button>
                            <button class="action-btn btn-reply" id="save-points">
                                <i class="fas fa-save"></i> Αποθήκευση Αλλαγών
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal επιτυχίας αποστολής -->
        <div class="modal" id="success-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Επιτυχία!</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="success-animation">
                        <i class="fas fa-check-circle"></i>
                        <h3>Το μήνυμα στάλθηκε επιτυχώς!</h3>
                        <p>Ο χρήστης θα ενημερωθεί για την απάντησή σας.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Βελτιωμένη ειδοποίηση -->
        <div class="notification-toast" id="notification-toast">
            <div class="notification-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title" id="notification-title">Νέα Ειδοποίηση</div>
                <div class="notification-message" id="notification-message">Έχετε νέα μηνύματα</div>
            </div>
            <button class="notification-close" id="notification-close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Ηχητική ειδοποίηση -->
        <audio id="notification-sound" class="sound-notification">
            <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
        </audio>
    </div>

    <script>
        // ΤΟ FIREBASE CONFIGURATION ΕΧΕΙ ΑΦΑΙΡΕΘΕΙ ΕΔΩ
        // ΚΑΙ ΒΡΙΣΚΕΤΑΙ ΣΤΟ panel-firebase-config.js
        
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase Authentication State Observer με persistence
            // ΤΟ auth ΚΑΙ db ΕΙΝΑΙ ΔΙΑΘΕΣΙΜΑ ΑΠΟ ΤΟ panel-firebase-config.js
            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            // Έλεγχος αν ο χρήστης είναι διαχειριστής
                            checkAdminUser(user.email).then((isAdmin) => {
                                if (isAdmin) {
                                    showMainApp(user.email);
                                    loadAllData();
                                    setupRealTimeListeners();
                                } else {
                                    showToast('Δεν έχετε δικαιώματα διαχειριστή!', 'error');
                                    auth.signOut();
                                }
                            });
                        } else {
                            showLoginModal();
                        }
                    });
                })
                .catch((error) => {
                    console.error("Error setting auth persistence:", error);
                });

            // Συνάρτηση ελέγχου διαχειριστή
            async function checkAdminUser(email) {
                try {
                    const adminSnapshot = await db.collection('admins')
                        .where('email', '==', email)
                        .get();
                        
                    return !adminSnapshot.empty;
                } catch (error) {
                    console.error('Error checking admin:', error);
                    return false;
                }
            }

            // Σύστημα Αυθεντικοποίησης
            const loginModal = document.getElementById('login-modal');
            const mainContent = document.getElementById('main-content');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const adminEmailInput = document.getElementById('admin-email');
            const adminPasswordInput = document.getElementById('admin-password');
            const rememberMeCheckbox = document.getElementById('remember-me');
            const firstTimeSetup = document.getElementById('first-time-setup');
            const adminNameSpan = document.getElementById('admin-name');

            // Εμφάνιση login modal
            function showLoginModal() {
                loginModal.style.display = 'flex';
                mainContent.style.display = 'none';
            }

            // Εμφάνιση κύριας εφαρμογής
            function showMainApp(email) {
                loginModal.style.display = 'none';
                mainContent.style.display = 'block';
                adminNameSpan.textContent = email.split('@')[0];
                
                // Αρχικοποίηση κύριας εφαρμογής
                initializeMainApp();
            }

            // Σύνδεση διαχειριστή
            adminLoginBtn.addEventListener('click', function() {
                const email = adminEmailInput.value.trim();
                const password = adminPasswordInput.value.trim();

                if (!email || !password) {
                    alert('Παρακαλώ συμπληρώστε όλα τα πεδία.');
                    return;
                }

                adminLoginBtn.disabled = true;
                adminLoginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Σύνδεση...';

                // Firebase Authentication
                auth.signInWithEmailAndPassword(email, password)
                    .then(async (userCredential) => {
                        // Έλεγχος αν είναι διαχειριστής
                        const isAdmin = await checkAdminUser(email);
                        
                        if (isAdmin) {
                            showToast('Επιτυχής σύνδεση!', 'success');
                            
                            // Δημιουργία εγγραφής διαχειριστή αν δεν υπάρχει
                            await db.collection('admins').doc(userCredential.user.uid).set({
                                email: email,
                                name: email.split('@')[0],
                                lastLogin: new Date().toISOString(),
                                browser: navigator.userAgent
                            }, { merge: true });
                            
                        } else {
                            showToast('Δεν έχετε δικαιώματα διαχειριστή!', 'error');
                            auth.signOut();
                        }
                    })
                    .catch((error) => {
                        console.error('Σφάλμα σύνδεσης:', error);
                        
                        if (error.code === 'auth/user-not-found') {
                            // Αν ο χρήστης δεν υπάρχει, εμφάνιση μηνύματος
                            showToast('Λάθος email ή κωδικός πρόσβασης.', 'error');
                        } else {
                            showToast('Σφάλμα σύνδεσης: ' + error.message, 'error');
                        }
                    })
                    .finally(() => {
                        adminLoginBtn.disabled = false;
                        adminLoginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Σύνδεση';
                    });
            });

            // Αποσύνδεση
            logoutBtn.addEventListener('click', function() {
                if (confirm('Είστε σίγουρος ότι θέλετε να αποσυνδεθείτε;')) {
                    auth.signOut();
                    showToast('Αποσυνδεθήκατε επιτυχώς.', 'info');
                }
            });

            // Enter key για login
            adminPasswordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    adminLoginBtn.click();
                }
            });

            // Συναρτήσεις Κύριας Εφαρμογής
            function initializeMainApp() {
                // Σύνδεση με την κύρια εφαρμογή
                document.getElementById('mainAppBtn').addEventListener('click', function() {
                    window.location.href = 'index.html';
                });

                // Συγχρονισμός χρηστών
                document.getElementById('syncUsersBtn').addEventListener('click', function() {
                    loadAllData();
                    showToast('Ο συγχρονισμός ολοκληρώθηκε!', 'success');
                });

                // Σύστημα καρτελών
                const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        
                        // Απενεργοποίηση όλων των καρτελών
                        tabs.forEach(t => t.classList.remove('active'));
                        tabContents.forEach(tc => tc.classList.remove('active'));
                        
                        // Ενεργοποίηση της επιλεγμένης καρτέλας
                        tab.classList.add('active');
                        document.getElementById(tabId).classList.add('active');

                        // Αν είναι η καρτέλα ειδοποιήσεων, φόρτωσε τις ειδοποιήσεις
                        if (tabId === 'notifications-tab') {
                            loadNotifications();
                        }
                        
                        // Αν είναι η καρτέλα προσφορών, φόρτωσε τη διαχείριση προσφορών
                        if (tabId === 'offers-tab') {
                            loadOffersManagement();
                        }
                    });
                });
                
                // Φόρτωση όλων των δεδομένων
                function loadAllData() {
                    loadPhotoSubmissions();
                    loadMessageSubmissions();
                    loadUsers();
                    loadOffersManagement();
                    loadNotifications();
                    updateStats();
                }

                // Real-time listeners για Firebase Firestore
                function setupRealTimeListeners() {
                    // Real-time για υποβολές
                    db.collection('submissions').onSnapshot((snapshot) => {
                        loadPhotoSubmissions();
                        loadMessageSubmissions();
                        updateStats();
                    });

                    // Real-time για χρήστες
                    db.collection('users').onSnapshot((snapshot) => {
                        loadUsers();
                        updateStats();
                    });

                    // Real-time για ειδοποιήσεις
                    db.collection('adminNotifications').onSnapshot((snapshot) => {
                        loadNotifications();
                        updateStats();
                    });
                }
                
                // Φόρτωση υποβολών φωτογραφιών από Firebase Firestore
                function loadPhotoSubmissions() {
                    const listContainer = document.getElementById('photo-submissions-list');
                    
                    db.collection('submissions').where('type', '==', 'photo').get()
                        .then((querySnapshot) => {
                            if (querySnapshot.empty) {
                                listContainer.innerHTML = `
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <i class="fas fa-images"></i>
                                        </div>
                                        <h3>Δεν βρέθηκαν υποβολές φωτογραφιών</h3>
                                        <p>Δεν υπάρχουν διαθέσιμες υποβολές προς το παρόν.</p>
                                    </div>
                                `;
                                return;
                            }
                            
                            listContainer.innerHTML = '';
                            
                            querySnapshot.forEach((doc) => {
                                const submission = doc.data();
                                const statusClass = `status-${submission.status || 'pending'}`;
                                const statusText = getStatusText(submission.status || 'pending');
                                
                                const photosHTML = submission.photos && submission.photos.length > 0 ? 
                                    submission.photos.map((photo, index) => `
                                        <div class="photo-item">
                                            <img src="${photo.data}" alt="Φωτογραφία καφέ" class="photo-image">
                                        </div>
                                    `).join('') : '<p>Δεν υπάρχουν φωτογραφίες</p>';
                                
                                // Βελτιωμένη εμφάνιση πληροφοριών καφεμαντείας
                                const coffeeReadingInfo = submission.coffeeTypeText ? `
                                    <div class="coffee-reading-info">
                                        <p><strong>Τύπος Καφεμαντείας:</strong> ${submission.coffeeTypeText}</p>
                                        <p><strong>Email Χρήστη:</strong> ${submission.userEmail || submission.email || 'Δεν παρέχεται'}</p>
                                        ${submission.desire ? `<p><strong>Επιθυμία Χρήστη:</strong> ${submission.desire}</p>` : ''}
                                    </div>
                                ` : '';
                                
                                // Πληροφορίες επιλεγμένου καφεμάντη
                                const fortuneTellerInfo = submission.fortuneTellerName ? `
                                    <div class="fortune-teller-info">
                                        <p><strong>Επιλεγμένος Καφεμάντης:</strong> ${submission.fortuneTellerName}</p>
                                        ${submission.fortuneTellerId ? `<p><strong>ID Καφεμάντη:</strong> ${submission.fortuneTellerId}</p>` : ''}
                                    </div>
                                ` : '';
                                
                                const submissionCard = document.createElement('div');
                                submissionCard.className = 'submission-card';
                                submissionCard.innerHTML = `
                                    <div class="submission-header">
                                        <div class="submission-user">${submission.userEmail || submission.email || 'Άγνωστος Χρήστης'}</div>
                                        <div class="submission-date">${formatDate(submission.date)}</div>
                                        <div class="submission-status ${statusClass}">${statusText}</div>
                                    </div>
                                    
                                    ${fortuneTellerInfo}
                                    ${coffeeReadingInfo}
                                    
                                    <div class="submission-content">
                                        <div class="submission-message">
                                            ${submission.message || 'Δεν υπάρχει μήνυμα'}
                                        </div>
                                        
                                        <div class="photos-grid">
                                            ${photosHTML}
                                        </div>
                                    </div>
                                    
                                    <div class="submission-actions">
                                        <button class="action-btn btn-view" data-id="${doc.id}">
                                            <i class="fas fa-eye"></i> Προβολή
                                        </button>
                                        <button class="action-btn btn-reply" data-id="${doc.id}">
                                            <i class="fas fa-reply"></i> Απάντηση
                                        </button>
                                        ${submission.photos && submission.photos.length > 0 ? `
                                        <button class="action-btn btn-download" data-id="${doc.id}">
                                            <i class="fas fa-download"></i> Λήψη
                                        </button>
                                        ` : ''}
                                        <button class="action-btn btn-delete" data-id="${doc.id}">
                                            <i class="fas fa-trash"></i> Διαγραφή
                                        </button>
                                    </div>
                                `;
                                
                                listContainer.appendChild(submissionCard);
                            });
                            
                            // Προσθήκη event listeners για τα κουμπιά
                            addActionEventListeners();
                        })
                        .catch((error) => {
                            console.error('Σφάλμα φόρτωσης υποβολών:', error);
                            listContainer.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <h3>Σφάλμα φόρτωσης δεδομένων</h3>
                                    <p>Παρακαλώ δοκιμάστε ξανά.</p>
                                </div>
                            `;
                        });
                }
                
                // Φόρτωση μηνυμάτων επικοινωνίας από Firebase Firestore
                function loadMessageSubmissions() {
                    const listContainer = document.getElementById('message-submissions-list');
                    
                    db.collection('submissions').where('type', '==', 'message').get()
                        .then((querySnapshot) => {
                            if (querySnapshot.empty) {
                                listContainer.innerHTML = `
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <i class="fas fa-envelope"></i>
                                        </div>
                                        <h3>Δεν βρέθηκαν μηνύματα</h3>
                                        <p>Δεν υπάρχουν διαθέσιμα μηνύματα προς το παρόν.</p>
                                    </div>
                                `;
                                return;
                            }
                            
                            listContainer.innerHTML = '';
                            
                            querySnapshot.forEach((doc) => {
                                const submission = doc.data();
                                const statusClass = `status-${submission.status || 'pending'}`;
                                const statusText = getStatusText(submission.status || 'pending');
                                
                                const submissionCard = document.createElement('div');
                                submissionCard.className = 'submission-card';
                                submissionCard.innerHTML = `
                                    <div class="submission-header">
                                        <div>
                                            <div class="submission-user">${submission.userName || 'Άγνωστος Χρήστης'}</div>
                                            <div class="submission-date">${submission.userEmail || submission.email || 'Χωρίς email'}</div>
                                        </div>
                                        <div class="submission-date">${formatDate(submission.date)}</div>
                                        <div class="submission-status ${statusClass}">${statusText}</div>
                                    </div>
                                    
                                    <div class="submission-content">
                                        <div><strong>Θέμα:</strong> ${submission.subject || 'Χωρίς θέμα'}</div>
                                        <div class="submission-message">${submission.message || 'Δεν υπάρχει μήνυμα'}</div>
                                    </div>
                                    
                                    <div class="submission-actions">
                                        <button class="action-btn btn-view" data-id="${doc.id}">
                                            <i class="fas fa-eye"></i> Προβολή
                                        </button>
                                        <button class="action-btn btn-reply" data-id="${doc.id}">
                                            <i class="fas fa-reply"></i> Απάντηση
                                        </button>
                                        <button class="action-btn btn-delete" data-id="${doc.id}">
                                            <i class="fas fa-trash"></i> Διαγραφή
                                        </button>
                                    </div>
                                `;
                                
                                listContainer.appendChild(submissionCard);
                            });
                            
                            // Προσθήκη event listeners για τα κουμπιά
                            addActionEventListeners();
                        })
                        .catch((error) => {
                            console.error('Σφάλμα φόρτωσης μηνυμάτων:', error);
                            listContainer.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <h3>Σφάλμα φόρτωσης δεδομένων</h3>
                                    <p>Παρακαλώ δοκιμάστε ξανά.</p>
                                </div>
                            `;
                        });
                }
                
                // Φόρτωση χρηστών από Firebase Firestore
                function loadUsers() {
                    const listContainer = document.getElementById('users-list');
                    
                    db.collection('users').get()
                        .then((querySnapshot) => {
                            if (querySnapshot.empty) {
                                listContainer.innerHTML = `
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <h3>Δεν βρέθηκαν εγγεγραμμένοι χρήστες</h3>
                                        <p>Δεν υπάρχουν εγγεγραμμένοι χρήστες προς το παρόν.</p>
                                    </div>
                                `;
                                return;
                            }
                            
                            let usersHTML = `
                                <table class="users-table">
                                    <thead>
                                        <tr>
                                            <th>Όνομα</th>
                                            <th>Email</th>
                                            <th>Πόντοι</th>
                                            <th>Επίπεδο</th>
                                            <th>Ημερομηνία Εγγραφής</th>
                                            <th>Ενέργειες</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            querySnapshot.forEach((doc) => {
                                const user = doc.data();
                                const userCategory = getUserCategory(user.points || 0);
                                
                                usersHTML += `
                                    <tr>
                                        <td>${user.name || 'Χωρίς όνομα'}</td>
                                        <td>${user.email}</td>
                                        <td>${user.points || 0}</td>
                                        <td>${user.level || 'Αρχάριος'} <span class="user-category ${userCategory.class}">${userCategory.name}</span></td>
                                        <td>${formatDate(user.registrationDate)}</td>
                                        <td>
                                            <div class="user-actions">
                                                <button class="action-btn btn-view view-user" data-id="${doc.id}" data-email="${user.email}">
                                                    <i class="fas fa-eye"></i> Προβολή
                                                </button>
                                                <button class="action-btn btn-reply manage-points" data-id="${doc.id}" data-email="${user.email}">
                                                    <i class="fas fa-coins"></i> Πόντοι
                                                </button>
                                                <button class="action-btn btn-delete delete-user" data-id="${doc.id}" data-email="${user.email}">
                                                    <i class="fas fa-trash"></i> Διαγραφή
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            usersHTML += `
                                    </tbody>
                                </table>
                            `;
                            
                            listContainer.innerHTML = usersHTML;
                            
                            // Προσθήκη event listeners για τα κουμπιά χρηστών
                            document.querySelectorAll('.view-user').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const userId = this.getAttribute('data-id');
                                    const userEmail = this.getAttribute('data-email');
                                    viewUser(userId, userEmail);
                                });
                            });
                            
                            document.querySelectorAll('.manage-points').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const userId = this.getAttribute('data-id');
                                    const userEmail = this.getAttribute('data-email');
                                    manageUserPoints(userId, userEmail);
                                });
                            });
                            
                            document.querySelectorAll('.delete-user').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const userId = this.getAttribute('data-id');
                                    const userEmail = this.getAttribute('data-email');
                                    deleteUser(userId, userEmail);
                                });
                            });
                        })
                        .catch((error) => {
                            console.error('Σφάλμα φόρτωσης χρηστών:', error);
                            listContainer.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <h3>Σφάλμα φόρτωσης δεδομένων</h3>
                                    <p>Παρακαλώ δοκιμάστε ξανά.</p>
                                </div>
                            `;
                        });
                }

                // Κατηγοριοποίηση χρηστών βάσει πόντων
                function getUserCategory(points) {
                    if (points < 50) {
                        return { class: 'category-beginner', name: 'Αρχάριος' };
                    } else if (points < 150) {
                        return { class: 'category-regular', name: 'Τακτικός' };
                    } else if (points < 300) {
                        return { class: 'category-vip', name: 'VIP' };
                    } else {
                        return { class: 'category-master', name: 'Master' };
                    }
                }

                // Φόρτωση διαχείρισης προσφορών από Firebase Firestore
                function loadOffersManagement() {
                    // Για το παρόν, η διαχείριση προσφορών θα γίνεται μέσω Firestore
                    // Θα μπορούσαμε να χρησιμοποιήσουμε ένα collection 'offers' στο μέλλον
                    document.getElementById('save-offer-1plus1').addEventListener('click', function() {
                        const status = document.getElementById('offer-1plus1-status').value;
                        const duration = parseInt(document.getElementById('offer-1plus1-duration').value);
                        
                        const active = status === 'active';
                        
                        // Εδώ θα μπορούσαμε να αποθηκεύουμε τις ρυθμίσεις στο Firestore
                        showToast(`Η προσφορά 1+1 ${active ? 'ενεργοποιήθηκε' : 'απενεργοποιήθηκε'}!`, 'success');
                    });
                }

                // Φόρτωση ειδοποιήσεων από Firebase Firestore
                function loadNotifications() {
                    const listContainer = document.getElementById('notifications-list');
                    const badge = document.getElementById('notificationsBadge');
                    
                    db.collection('adminNotifications').orderBy('date', 'desc').get()
                        .then((querySnapshot) => {
                            // Ενημέρωση badge
                            let pendingCount = 0;
                            querySnapshot.forEach(doc => {
                                const notification = doc.data();
                                if (notification.status === 'pending') {
                                    pendingCount++;
                                }
                            });
                            
                            if (pendingCount > 0) {
                                badge.textContent = pendingCount;
                                badge.style.display = 'flex';
                            } else {
                                badge.style.display = 'none';
                            }
                            
                            if (querySnapshot.empty) {
                                listContainer.innerHTML = `
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <i class="fas fa-bell-slash"></i>
                                        </div>
                                        <h3>Δεν υπάρχουν ειδοποιήσεις</h3>
                                        <p>Όλες οι ειδοποιήσεις έχουν επεξεργαστεί.</p>
                                    </div>
                                `;
                                return;
                            }
                            
                            listContainer.innerHTML = '';
                            
                            querySnapshot.forEach((doc) => {
                                const notification = doc.data();
                                const statusClass = `status-${notification.status || 'pending'}`;
                                const statusText = getNotificationStatusText(notification.status || 'pending');
                                
                                const notificationCard = document.createElement('div');
                                notificationCard.className = 'submission-card';
                                notificationCard.innerHTML = `
                                    <div class="submission-header">
                                        <div class="submission-user">${notification.userName || notification.userEmail || 'Άγνωστος Χρήστης'}</div>
                                        <div class="submission-date">${formatDate(notification.date)}</div>
                                        <div class="submission-status ${statusClass}">${statusText}</div>
                                    </div>
                                    
                                    <div class="submission-content">
                                        <div class="submission-message">
                                            <strong>Τύπος:</strong> ${getNotificationTypeText(notification.type)}<br>
                                            ${notification.coffeeTypeText ? `<strong>Τύπος Καφεμαντείας:</strong> ${notification.coffeeTypeText}<br>` : ''}
                                            ${notification.desire ? `<strong>Επιθυμία Χρήστη:</strong> ${notification.desire}<br>` : ''}
                                            ${notification.offerTitle ? `<strong>Προσφορά:</strong> ${notification.offerTitle}<br>` : ''}
                                            ${notification.character ? `<strong>Επιλεγμένος Χαρακτήρας:</strong> ${notification.character}<br>` : ''}
                                            <strong>Χρήστης:</strong> ${notification.userEmail || 'Χωρίς email'}
                                        </div>
                                    </div>
                                    
                                    <div class="submission-actions">
                                        <button class="action-btn btn-view view-notification" data-id="${doc.id}">
                                            <i class="fas fa-eye"></i> Προβολή
                                        </button>
                                        ${notification.status === 'pending' ? `
                                        <button class="action-btn btn-reply mark-processed" data-id="${doc.id}">
                                            <i class="fas fa-check"></i> Επεξεργασμένη
                                        </button>
                                        ` : ''}
                                        <button class="action-btn btn-delete delete-notification" data-id="${doc.id}">
                                            <i class="fas fa-trash"></i> Διαγραφή
                                        </button>
                                    </div>
                                `;
                                
                                listContainer.appendChild(notificationCard);
                            });
                            
                            // Προσθήκη event listeners για ειδοποιήσεις
                            document.querySelectorAll('.view-notification').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const notificationId = this.getAttribute('data-id');
                                    viewNotification(notificationId);
                                });
                            });
                            
                            document.querySelectorAll('.mark-processed').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const notificationId = this.getAttribute('data-id');
                                    markNotificationProcessed(notificationId);
                                });
                            });
                            
                            document.querySelectorAll('.delete-notification').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const notificationId = this.getAttribute('data-id');
                                    deleteNotification(notificationId);
                                });
                            });
                        })
                        .catch((error) => {
                            console.error('Σφάλμα φόρτωσης ειδοποιήσεων:', error);
                            listContainer.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <h3>Σφάλμα φόρτωσης δεδομένων</h3>
                                    <p>Παρακαλώ δοκιμάστε ξανά.</p>
                                </div>
                            `;
                        });
                }
                
                // Βοηθητικές συναρτήσεις
                function getStatusText(status) {
                    const statusMap = {
                        'pending': 'Σε Εκκρεμότητα',
                        'reviewed': 'Εξετασμένη',
                        'answered': 'Απαντημένη'
                    };
                    return statusMap[status] || status;
                }

                function getNotificationStatusText(status) {
                    const statusMap = {
                        'pending': 'Σε Εκκρεμότητα',
                        'processed': 'Επεξεργασμένη'
                    };
                    return statusMap[status] || status;
                }

                function getNotificationTypeText(type) {
                    const typeMap = {
                        'offer_redemption': 'Ανταλλαγή Προσφοράς',
                        'coffee_reading': 'Υποβολή Καφεμαντείας',
                        'character_selection': 'Επιλογή Χαρακτήρα',
                        'contact_message': 'Μήνυμα Επικοινωνίας'
                    };
                    return typeMap[type] || type;
                }
                
                function formatDate(dateString) {
                    try {
                        if (!dateString) return 'Άγνωστη ημερομηνία';
                        const options = { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        };
                        return new Date(dateString).toLocaleDateString('el-GR', options);
                    } catch (e) {
                        return 'Άγνωστη ημερομηνία';
                    }
                }
                
                // Προσθήκη event listeners για ενέργειες
                function addActionEventListeners() {
                    // Προβολή υποβολής
                    document.querySelectorAll('.btn-view').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const submissionId = this.getAttribute('data-id');
                            viewSubmission(submissionId);
                        });
                    });
                    
                    // Απάντηση
                    document.querySelectorAll('.btn-reply').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const submissionId = this.getAttribute('data-id');
                            openReplyModal(submissionId);
                        });
                    });
                    
                    // Λήψη φωτογραφιών
                    document.querySelectorAll('.btn-download').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const submissionId = this.getAttribute('data-id');
                            downloadSubmission(submissionId);
                        });
                    });
                    
                    // Διαγραφή
                    document.querySelectorAll('.btn-delete').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const submissionId = this.getAttribute('data-id');
                            deleteSubmission(submissionId);
                        });
                    });
                }
                
                // Λειτουργίες modal
                const submissionModal = document.getElementById('submission-modal');
                const replyModal = document.getElementById('reply-modal');
                const pointsModal = document.getElementById('points-modal');
                const successModal = document.getElementById('success-modal');
                const closeModalButtons = document.querySelectorAll('.close-modal');
                
                // Κλείσιμο modal
                closeModalButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        submissionModal.style.display = 'none';
                        replyModal.style.display = 'none';
                        pointsModal.style.display = 'none';
                        successModal.style.display = 'none';
                    });
                });
                
                // Κλείσιμο modal με κλικ έξω από το περιεχόμενο
                window.addEventListener('click', function(event) {
                    if (event.target === submissionModal) {
                        submissionModal.style.display = 'none';
                    }
                    if (event.target === replyModal) {
                        replyModal.style.display = 'none';
                    }
                    if (event.target === pointsModal) {
                        pointsModal.style.display = 'none';
                    }
                    if (event.target === successModal) {
                        successModal.style.display = 'none';
                    }
                });
                
                // Προβολή υποβολής
                function viewSubmission(id) {
                    db.collection('submissions').doc(id).get()
                        .then((doc) => {
                            if (!doc.exists) return;
                            
                            const submission = doc.data();
                            const modalBody = document.getElementById('modal-body');
                            
                            if (submission.type === 'photo') {
                                const photosHTML = submission.photos && submission.photos.length > 0 ? 
                                    submission.photos.map(photo => `
                                        <div class="photo-item">
                                            <img src="${photo.data}" alt="Φωτογραφία καφέ" class="photo-image">
                                        </div>
                                    `).join('') : '<p>Δεν υπάρχουν φωτογραφίες</p>';
                                
                                // Βελτιωμένη εμφάνιση πληροφοριών καφεμαντείας
                                const coffeeReadingInfo = submission.coffeeTypeText ? `
                                    <div class="coffee-reading-info">
                                        <p><strong>Τύπος Καφεμαντείας:</strong> ${submission.coffeeTypeText}</p>
                                        <p><strong>Email Χρήστη:</strong> ${submission.userEmail || submission.email || 'Δεν παρέχεται'}</p>
                                        ${submission.desire ? `<p><strong>Επιθυμία Χρήστη:</strong> ${submission.desire}</p>` : ''}
                                    </div>
                                ` : '';
                                
                                // Πληροφορίες επιλεγμένου καφεμάντη
                                const fortuneTellerInfo = submission.fortuneTellerName ? `
                                    <div class="fortune-teller-info">
                                        <p><strong>Επιλεγμένος Καφεμάντης:</strong> ${submission.fortuneTellerName}</p>
                                        ${submission.fortuneTellerId ? `<p><strong>ID Καφεμάντη:</strong> ${submission.fortuneTellerId}</p>` : ''}
                                    </div>
                                ` : '';
                                
                                modalBody.innerHTML = `
                                    <div class="submission-header">
                                        <div class="submission-user">${submission.userEmail || submission.email || 'Άγνωστος Χρήστης'}</div>
                                        <div class="submission-date">${formatDate(submission.date)}</div>
                                    </div>
                                    
                                    ${fortuneTellerInfo}
                                    ${coffeeReadingInfo}
                                    
                                    <div class="submission-content">
                                        <div class="submission-message">
                                            <strong>Μήνυμα:</strong><br>
                                            ${submission.message || 'Δεν υπάρχει μήνυμα'}
                                        </div>
                                        
                                        <div class="preview-title">
                                            <i class="fas fa-images"></i> Φωτογραφίες:
                                        </div>
                                        <div class="photos-grid">
                                            ${photosHTML}
                                        </div>
                                    </div>
                                `;
                            } else {
                                modalBody.innerHTML = `
                                    <div class="submission-header">
                                        <div>
                                            <div class="submission-user">${submission.userName || 'Άγνωστος Χρήστης'}</div>
                                            <div class="submission-date">${submission.userEmail || submission.email || 'Χωρίς email'}</div>
                                        </div>
                                        <div class="submission-date">${formatDate(submission.date)}</div>
                                    </div>
                                    
                                    <div class="submission-content">
                                        <div><strong>Θέμα:</strong> ${submission.subject || 'Χωρίς θέμα'}</div>
                                        <div class="submission-message">
                                            <strong>Μήνυμα:</strong><br>
                                            ${submission.message || 'Δεν υπάρχει μήνυμα'}
                                        </div>
                                    </div>
                                `;
                            }
                            
                            submissionModal.style.display = 'flex';
                        })
                        .catch((error) => {
                            console.error('Σφάλμα προβολής υποβολής:', error);
                            alert('Σφάλμα φόρτωσης υποβολής!');
                        });
                }
                
                // Προβολή χρήστη
                function viewUser(id, email) {
                    db.collection('users').doc(id).get()
                        .then((doc) => {
                            if (!doc.exists) return;
                            
                            const user = doc.data();
                            const modalBody = document.getElementById('modal-body');
                            
                            modalBody.innerHTML = `
                                <div class="submission-header">
                                    <div class="submission-user">${user.name || 'Χωρίς όνομα'}</div>
                                    <div class="submission-date">${formatDate(user.registrationDate)}</div>
                                </div>
                                
                                <div class="submission-content">
                                    <div><strong>Email:</strong> ${user.email}</div>
                                    <div><strong>Πόντοι:</strong> ${user.points || 0}</div>
                                    <div><strong>Επίπεδο:</strong> ${user.level || 'Αρχάριος'}</div>
                                    <div><strong>Ημερομηνία Εγγραφής:</strong> ${formatDate(user.registrationDate)}</div>
                                    <div><strong>ID Χρήστη:</strong> ${id}</div>
                                    ${user.lastLogin ? `<div><strong>Τελευταία Σύνδεση:</strong> ${formatDate(user.lastLogin)}</div>` : ''}
                                    ${user.browser ? `<div><strong>Browser:</strong> ${user.browser}</div>` : ''}
                                </div>
                            `;
                            
                            submissionModal.style.display = 'flex';
                        })
                        .catch((error) => {
                            console.error('Σφάλμα προβολής χρήστη:', error);
                            alert('Σφάλμα φόρτωσης χρήστη!');
                        });
                }

                // Προβολή ειδοποίησης
                function viewNotification(id) {
                    db.collection('adminNotifications').doc(id).get()
                        .then((doc) => {
                            if (!doc.exists) return;
                            
                            const notification = doc.data();
                            const modalBody = document.getElementById('modal-body');
                            
                            modalBody.innerHTML = `
                                <div class="submission-header">
                                    <div class="submission-user">${notification.userName || notification.userEmail || 'Άγνωστος Χρήστης'}</div>
                                    <div class="submission-date">${formatDate(notification.date)}</div>
                                </div>
                                
                                <div class="submission-content">
                                    <div><strong>Τύπος:</strong> ${getNotificationTypeText(notification.type)}</div>
                                    ${notification.coffeeTypeText ? `<div><strong>Τύπος Καφεμαντείας:</strong> ${notification.coffeeTypeText}</div>` : ''}
                                    ${notification.desire ? `<div><strong>Επιθυμία Χρήστη:</strong> ${notification.desire}</div>` : ''}
                                    ${notification.offerTitle ? `<div><strong>Προσφορά:</strong> ${notification.offerTitle}</div>` : ''}
                                    ${notification.character ? `<div><strong>Επιλεγμένος Χαρακτήρας:</strong> ${notification.character}</div>` : ''}
                                    <div><strong>Χρήστης:</strong> ${notification.userEmail || 'Χωρίς email'}</div>
                                    <div><strong>Ημερομηνία:</strong> ${formatDate(notification.date)}</div>
                                    <div><strong>Κατάσταση:</strong> ${getNotificationStatusText(notification.status)}</div>
                                </div>
                            `;
                            
                            submissionModal.style.display = 'flex';
                        })
                        .catch((error) => {
                            console.error('Σφάλμα προβολής ειδοποίησης:', error);
                            alert('Σφάλμα φόρτωσης ειδοποίησης!');
                        });
                }

                // Σήμανση ειδοποίησης ως επεξεργασμένης
                function markNotificationProcessed(id) {
                    db.collection('adminNotifications').doc(id).update({
                        status: 'processed',
                        processedAt: new Date().toISOString()
                    })
                    .then(() => {
                        showToast('Η ειδοποίηση σημάνθηκε ως επεξεργασμένη!', 'success');
                        loadNotifications();
                    })
                    .catch((error) => {
                        console.error('Σφάλμα σήμανσης ειδοποίησης:', error);
                        showToast('Σφάλμα σήμανσης ειδοποίησης!', 'error');
                    });
                }

                // Διαγραφή ειδοποίησης
                function deleteNotification(id) {
                    if (confirm('Είστε σίγουρος ότι θέλετε να διαγράψετε αυτή την ειδοποίηση;')) {
                        db.collection('adminNotifications').doc(id).delete()
                            .then(() => {
                                showToast('Η ειδοποίηση διαγράφηκε επιτυχώς!', 'success');
                                loadNotifications();
                            })
                            .catch((error) => {
                                console.error('Σφάλμα διαγραφής ειδοποίησης:', error);
                                showToast('Σφάλμα διαγραφής ειδοποίησης!', 'error');
                            });
                    }
                }
                
                // Διαχείριση πόντων χρήστη
                function manageUserPoints(userId, userEmail) {
                    db.collection('users').doc(userId).get()
                        .then((doc) => {
                            if (!doc.exists) return;
                            
                            const user = doc.data();
                            const pointsUserInfo = document.getElementById('points-user-info');
                            
                            pointsUserInfo.innerHTML = `
                                <div class="submission-header">
                                    <div class="submission-user">${user.name || 'Χωρίς όνομα'}</div>
                                    <div class="submission-date">${user.email}</div>
                                </div>
                                
                                <div class="submission-content">
                                    <div><strong>Τρέχοντες Πόντοι:</strong> ${user.points || 0}</div>
                                    <div><strong>Τρέχον Επίπεδο:</strong> ${user.level || 'Αρχάριος'}</div>
                                </div>
                            `;
                            
                            document.getElementById('current-points').value = user.points || 0;
                            document.getElementById('points-amount').value = 0;
                            document.getElementById('points-reason').value = '';
                            
                            pointsModal.style.display = 'flex';
                            
                            // Αποθήκευση του userId για χρήση στην αποθήκευση
                            document.getElementById('save-points').setAttribute('data-id', userId);
                        })
                        .catch((error) => {
                            console.error('Σφάλμα φόρτωσης χρήστη:', error);
                            alert('Σφάλμα φόρτωσης χρήστη!');
                        });
                }
                
                // Αποθήκευση αλλαγών πόντων
                document.getElementById('save-points').addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    const currentPoints = parseInt(document.getElementById('current-points').value);
                    const action = document.getElementById('points-action').value;
                    const amount = parseInt(document.getElementById('points-amount').value);
                    const reason = document.getElementById('points-reason').value;
                    
                    if (isNaN(amount) || amount < 0) {
                        alert('Παρακαλώ εισάγετε έγκυρη ποσότητα πόντων.');
                        return;
                    }
                    
                    let newPoints = currentPoints;
                    
                    switch(action) {
                        case 'add':
                            newPoints += amount;
                            break;
                        case 'remove':
                            newPoints = Math.max(0, currentPoints - amount);
                            break;
                        case 'set':
                            newPoints = amount;
                            break;
                    }
                    
                    // Ενημέρωση επιπέδου
                    let level = 'Αρχάριος';
                    if (newPoints >= 100) level = 'Ειδικός';
                    if (newPoints >= 300) level = 'Μάστερ';
                    if (newPoints >= 500) level = 'Grand Master';
                    
                    // Ενημέρωση των πόντων του χρήστη
                    db.collection('users').doc(userId).update({
                        points: newPoints,
                        level: level,
                        lastUpdated: new Date().toISOString()
                    })
                    .then(() => {
                        // Καταγραφή της αλλαγής
                        db.collection('pointsHistory').add({
                            userId: userId,
                            action: action,
                            amount: amount,
                            previousPoints: currentPoints,
                            newPoints: newPoints,
                            reason: reason,
                            date: new Date().toISOString(),
                            admin: auth.currentUser.email
                        });
                        
                        showToast(`Οι πόντοι του χρήστη ενημερώθηκαν επιτυχώς! Νέοι πόντοι: ${newPoints}`, 'success');
                        pointsModal.style.display = 'none';
                        loadUsers();
                    })
                    .catch((error) => {
                        console.error('Σφάλμα ενημέρωσης πόντων:', error);
                        showToast('Σφάλμα ενημέρωσης πόντων!', 'error');
                    });
                });
                
                // Ακύρωση διαχείρισης πόντων
                document.getElementById('cancel-points').addEventListener('click', function() {
                    pointsModal.style.display = 'none';
                });
                
                // Νέα λειτουργία για URL detection και preview
                const replyMessageTextarea = document.getElementById('reply-message');
                const urlPreview = document.getElementById('url-preview');
                const urlPreviewContent = document.getElementById('url-preview-content');
                
                // Λειτουργία για ανίχνευση URLs και προεπισκόπηση
                replyMessageTextarea.addEventListener('input', function() {
                    const text = this.value;
                    const urls = extractUrls(text);
                    
                    if (urls.length > 0) {
                        urlPreviewContent.innerHTML = urls.map(url => `
                            <div class="url-item">
                                <i class="fas fa-link"></i>
                                <a href="${url}" target="_blank" class="preview-link">${url}</a>
                                <span class="url-note">(θα ανοίξει σε νέα καρτέλα)</span>
                            </div>
                        `).join('');
                        urlPreview.style.display = 'block';
                    } else {
                        urlPreview.style.display = 'none';
                    }
                });
                
                // Συνάρτηση εξαγωγής URLs από κείμενο
                function extractUrls(text) {
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    return text.match(urlRegex) || [];
                }
                
                // Συνάρτηση μετατροπής URLs σε clickable links
                function convertUrlsToLinks(text) {
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    return text.replace(urlRegex, function(url) {
                        return `<a href="${url}" target="_blank" class="message-link">${url}</a>`;
                    });
                }
                
                // Άνοιγμα modal απάντησης
                function openReplyModal(id) {
                    db.collection('submissions').doc(id).get()
                        .then((doc) => {
                            if (!doc.exists) return;
                            
                            const submission = doc.data();
                            const userInfo = document.getElementById('reply-user-info');
                            
                            if (submission.type === 'photo') {
                                userInfo.innerHTML = `
                                    <div class="submission-header">
                                        <div class="submission-user">Απάντηση σε: ${submission.userEmail || submission.email || 'Άγνωστος Χρήστης'}</div>
                                        <div class="submission-date">${formatDate(submission.date)}</div>
                                    </div>
                                    
                                    <div class="submission-content">
                                        <div class="submission-message">
                                            <strong>Τύπος Καφεμαντείας:</strong> ${submission.coffeeTypeText || 'Γραπτή Ερμηνεία'}<br>
                                            ${submission.fortuneTellerName ? `<strong>Επιλεγμένος Καφεμάντης:</strong> ${submission.fortuneTellerName}<br>` : ''}
                                            ${submission.desire ? `<strong>Επιθυμία Χρήστη:</strong><br>${submission.desire}<br><br>` : ''}
                                            <strong>Αρχικό Μήνυμα:</strong><br>
                                            ${submission.message || 'Δεν υπάρχει μήνυμα'}
                                        </div>
                                    </div>
                                `;
                            } else {
                                userInfo.innerHTML = `
                                    <div class="submission-header">
                                        <div>
                                            <div class="submission-user">Απάντηση σε: ${submission.userName || 'Άγνωστος Χρήστης'}</div>
                                            <div class="submission-date">${submission.userEmail || submission.email || 'Χωρίς email'}</div>
                                        </div>
                                        <div class="submission-date">${formatDate(submission.date)}</div>
                                    </div>
                                    
                                    <div class="submission-content">
                                        <div><strong>Θέμα:</strong> ${submission.subject || 'Χωρίς θέμα'}</div>
                                        <div class="submission-message">
                                            <strong>Αρχικό Μήνυμα:</strong><br>
                                            ${submission.message || 'Δεν υπάρχει μήνυμα'}
                                        </div>
                                    </div>
                                `;
                            }
                            
                            document.getElementById('reply-message').value = '';
                            urlPreview.style.display = 'none';
                            replyModal.style.display = 'flex';
                            
                            // Αποθήκευση του ID για χρήση στην αποστολή
                            document.getElementById('send-reply').setAttribute('data-id', id);
                        })
                        .catch((error) => {
                            console.error('Σφάλμα φόρτωσης υποβολής:', error);
                            alert('Σφάλμα φόρτωσης υποβολής!');
                        });
                }
                
                // Αποστολή απάντησης
                document.getElementById('send-reply').addEventListener('click', function() {
                    const replyMessage = document.getElementById('reply-message').value;
                    const submissionId = this.getAttribute('data-id');
                    
                    if (!replyMessage.trim()) {
                        alert('Παρακαλώ εισάγετε μήνυμα απάντησης.');
                        return;
                    }
                    
                    // Μετατροπή URLs σε links
                    const formattedMessage = convertUrlsToLinks(replyMessage);
                    
                    // Βρες την υποβολή
                    db.collection('submissions').doc(submissionId).get()
                        .then((doc) => {
                            if (!doc.exists) {
                                alert('Δεν βρέθηκε η υποβολή!');
                                return;
                            }
                            
                            const submission = doc.data();
                            
                            // Δημιουργία απάντησης
                            const response = {
                                submissionId: submissionId,
                                userEmail: submission.userEmail || submission.email,
                                adminMessage: formattedMessage,
                                originalMessage: submission.message || submission.subject,
                                fortuneTellerName: submission.fortuneTellerName,
                                date: new Date().toISOString(),
                                status: 'sent',
                                adminUser: auth.currentUser.email,
                                viewed: false
                            };
                            
                            // Αποθήκευση απάντησης
                            return db.collection('responses').add(response);
                        })
                        .then(() => {
                            // Ενημέρωση κατάστασης υποβολής
                            return db.collection('submissions').doc(submissionId).update({
                                status: 'answered',
                                answeredAt: new Date().toISOString()
                            });
                        })
                        .then(() => {
                            // Αποστολή
                            this.disabled = true;
                            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Αποστολή...';
                            
                            setTimeout(() => {
                                // Αναπαραγωγή ήχου
                                playNotificationSound();
                                
                                // Κλείσιμο modal απάντησης
                                replyModal.style.display = 'none';
                                
                                // Εμφάνιση modal επιτυχίας
                                successModal.style.display = 'flex';
                                
                                // Επαναφορά κουμπιού
                                this.disabled = false;
                                this.innerHTML = '<i class="fas fa-paper-plane"></i> Αποστολή Απάντησης';
                                
                                // Ανανέωση δεδομένων
                                loadAllData();
                                
                                // Αυτόματο κλείσιμο modal επιτυχίας μετά από 3 δευτερόλεπτα
                                setTimeout(() => {
                                    successModal.style.display = 'none';
                                }, 3000);
                            }, 1500);
                        })
                        .catch((error) => {
                            console.error('Σφάλμα αποστολής απάντησης:', error);
                            alert('Σφάλμα αποστολής απάντησης!');
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-paper-plane"></i> Αποστολή Απάντησης';
                        });
                });
                
                // Αναπαραγωγή ήχου ειδοποίησης
                function playNotificationSound() {
                    const sound = document.getElementById('notification-sound');
                    sound.play().catch(e => {
                        console.log('Αποτυχία αναπαραγωγής ήχου:', e);
                    });
                }
                
                // Ακύρωση απάντησης
                document.getElementById('cancel-reply').addEventListener('click', function() {
                    replyModal.style.display = 'none';
                });
                
                // Λήψη υποβολής
                function downloadSubmission(id) {
                    db.collection('submissions').doc(id).get()
                        .then((doc) => {
                            const submission = doc.data();
                            
                            if (submission && submission.type === 'photo' && submission.photos && submission.photos.length > 0) {
                                // Δημιουργία ZIP με τις φωτογραφίες (θα γινόταν στην πραγματικότητα)
                                alert(`Λήψη ${submission.photos.length} φωτογραφιών από τον χρήστη ${submission.userEmail || submission.email}`);
                            } else {
                                alert('Δεν βρέθηκαν φωτογραφίες για λήψη');
                            }
                        })
                        .catch((error) => {
                            console.error('Σφάλμα λήψης υποβολής:', error);
                            alert('Σφάλμα λήψης υποβολής!');
                        });
                }
                
                // Διαγραφή υποβολής
                function deleteSubmission(id) {
                    if (confirm('Είστε σίγουρος ότι θέλετε να διαγράψετε αυτή την υποβολή;')) {
                        db.collection('submissions').doc(id).delete()
                            .then(() => {
                                showToast('Η υποβολή διαγράφηκε επιτυχώς!', 'success');
                                loadAllData();
                            })
                            .catch((error) => {
                                console.error('Σφάλμα διαγραφής υποβολής:', error);
                                showToast('Σφάλμα διαγραφής υποβολής!', 'error');
                            });
                    }
                }
                
                // Διαγραφή χρήστη
                function deleteUser(userId, userEmail) {
                    if (confirm('Είστε σίγουρος ότι θέλετε να διαγράψετε αυτόν τον χρήστη και όλα τα σχετικά δεδομένα;')) {
                        
                        // 1. Διαγραφή από Firestore
                        db.collection('users').doc(userId).delete()
                            .then(() => {
                                // 2. Διαγραφή υποβολών του χρήστη
                                return db.collection('submissions')
                                    .where('userId', '==', userId)
                                    .get()
                                    .then((querySnapshot) => {
                                        const batch = db.batch();
                                        querySnapshot.forEach((doc) => {
                                            batch.delete(doc.ref);
                                        });
                                        return batch.commit();
                                    });
                            })
                            .then(() => {
                                // 3. Διαγραφή ειδοποιήσεων του χρήστη
                                return db.collection('adminNotifications')
                                    .where('userId', '==', userId)
                                    .get()
                                    .then((querySnapshot) => {
                                        const batch = db.batch();
                                        querySnapshot.forEach((doc) => {
                                            batch.delete(doc.ref);
                                        });
                                        return batch.commit();
                                    });
                            })
                            .then(() => {
                                // 4. Διαγραφή απαντήσεων του χρήστη
                                return db.collection('responses')
                                    .where('userEmail', '==', userEmail)
                                    .get()
                                    .then((querySnapshot) => {
                                        const batch = db.batch();
                                        querySnapshot.forEach((doc) => {
                                            batch.delete(doc.ref);
                                        });
                                        return batch.commit();
                                    });
                            })
                            .then(() => {
                                showToast('Ο χρήστης και όλα τα σχετικά δεδομένα διαγράφηκαν επιτυχώς!', 'success');
                                loadUsers();
                            })
                            .catch((error) => {
                                console.error('Σφάλμα διαγραφής χρήστη:', error);
                                showToast('Σφάλμα διαγραφής χρήστη!', 'error');
                            });
                    }
                }
                
                // Ενημέρωση στατιστικών
                function updateStats() {
                    // Συνολικές υποβολές
                    db.collection('submissions').get()
                        .then((querySnapshot) => {
                            const total = querySnapshot.size;
                            document.getElementById('total-submissions').textContent = total;
                            
                            // Υποβολές σε εκκρεμότητα
                            let pending = 0;
                            let answered = 0;
                            
                            querySnapshot.forEach((doc) => {
                                const submission = doc.data();
                                if (submission.status === 'pending') pending++;
                                if (submission.status === 'answered') answered++;
                            });
                            
                            document.getElementById('pending-submissions').textContent = pending;
                            document.getElementById('answered-submissions').textContent = answered;
                        })
                        .catch((error) => {
                            console.error('Σφάλμα στατιστικών υποβολών:', error);
                        });
                    
                    // Εγγεγραμμένοι χρήστες
                    db.collection('users').get()
                        .then((querySnapshot) => {
                            const total = querySnapshot.size;
                            document.getElementById('registered-users').textContent = total;
                        })
                        .catch((error) => {
                            console.error('Σφάλμα στατιστικών χρηστών:', error);
                        });
                }
                
                // Βελτιωμένη ειδοποίηση (Toast)
                const notificationToast = document.getElementById('notification-toast');
                const notificationTitle = document.getElementById('notification-title');
                const notificationMessage = document.getElementById('notification-message');
                const notificationClose = document.getElementById('notification-close');
                
                notificationClose.addEventListener('click', function() {
                    notificationToast.classList.remove('show');
                });
                
                function showToast(message, type) {
                    // Ορισμός χρώματος και εικονιδίου ανάλογα με τον τύπο
                    let icon = 'fas fa-bell';
                    let color = 'var(--info)';
                    
                    switch(type) {
                        case 'success':
                            icon = 'fas fa-check-circle';
                            color = 'var(--success)';
                            break;
                        case 'error':
                            icon = 'fas fa-exclamation-circle';
                            color = 'var(--error)';
                            break;
                        case 'warning':
                            icon = 'fas fa-exclamation-triangle';
                            color = 'var(--warning)';
                            break;
                    }
                    
                    // Ενημέρωση περιεχομένου
                    notificationTitle.textContent = type === 'success' ? 'Επιτυχία' : 
                                                   type === 'error' ? 'Σφάλμα' : 
                                                   type === 'warning' ? 'Προσοχή' : 'Ειδοποίηση';
                    notificationMessage.textContent = message;
                    
                    // Ενημέρωση εικονιδίου και χρώματος
                    notificationToast.querySelector('.notification-icon i').className = icon;
                    notificationToast.style.borderLeftColor = color;
                    
                    // Εμφάνιση
                    notificationToast.classList.add('show');
                    
                    // Αυτόματη απόκρυψη μετά από 5 δευτερόλεπτα
                    setTimeout(() => {
                        notificationToast.classList.remove('show');
                    }, 5000);
                }
                
                // Αρχική φόρτωση δεδομένων
                loadAllData();
            }
        });
    </script>
</body>
</html>
